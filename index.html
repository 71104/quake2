<!DOCTYPE html><html lang=en><head><style>/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */img,legend{border:0}legend,td,th{padding:0}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,optgroup,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre,textarea{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}table{border-collapse:collapse;border-spacing:0}
body,html{margin:0;border:none;padding:0;overflow:hidden}canvas#canvas{position:absolute;width:100%;height:100%}</style><script src=js/jquery-3.2.1.min.js></script><script>!function(t){const e={};e.inherit=function(t,e){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},Array.prototype.unique=function(){const t=this.slice().sort(function(t,e){return t<e?-1:t>e?1:0});if(t.length){var e=t[0];const n=[e];for(var i=1;i<t.length;i++)t[i]!==e&&(e=t[i],n.push(e));return n}return[]},Array.prototype.flatten=function(){return[].concat.apply([],this)},e.Loader=function(){},e.Loader._WEAPON_MODELS=["weapons/v_bfg","weapons/v_blast","weapons/v_chain","weapons/v_disint","weapons/v_flareg","weapons/v_handgr","weapons/v_hyperb","weapons/v_launch","weapons/v_machn","weapons/v_rail","weapons/v_rocket","weapons/v_shotg","weapons/v_shotg2"],e.Loader.prototype._loadHash=function(t){const e=Object.keys(t);return Promise.all(e.map(function(e){return Promise.resolve(t[e])})).then(function(t){const i=Object.create(null);return e.forEach(function(e,n){i[e]=t[n]}),i})},e.Loader.prototype.loadData=function(t){return Promise.resolve($.getJSON("baseq2/"+t+".json"))},e.Loader.prototype.loadImage=function(t){return new Promise(function(e,i){const n=new Image;n.onload=function(){n.onload=null,n.onerror=null,e(n)},n.onerror=function(){n.onload=null,n.onerror=null,i(new Error("Failed to load "+t))},n.src="baseq2/"+t})},e.Loader.prototype.loadImages=function(t){return Promise.all(t.map(function(t){return this.loadImage(t)},this))},e.Loader.prototype.loadTexture=function(t){return this.loadImage("textures/"+t+".png")},e.Loader.prototype.loadTextures=function(t){return this.loadImages(t.map(function(t){return"textures/"+t+".png"}))},e.Loader.prototype.loadSkins=function(t){return Promise.all(t.map(function(t){return this.loadImage(t+".png")},this)).then(function(e){const i=Object.create(null);return t.forEach(function(t,n){i[t]=e[n]}),i})},e.Loader.prototype.loadModel=function(t){const e={};return this.loadData("models/"+t+"/tris").then(function(t){return e.data=t,this.loadSkins(t.skin.names)}.bind(this)).then(function(t){return e.skins=t,e}.bind(this))},e.Loader.prototype._loadEntityModels=function(t){const i=Object.create(null);e.Loader._WEAPON_MODELS.forEach(function(t){i[t]=!0}),t.filter(function(t){return t.classname in e.Entities.dictionary},this).forEach(function(t){e.Entities.dictionary[t.classname].MODELS.forEach(function(t){i[t]=!0},this)},this);for(var n in i)i[n]=this.loadModel(n);return this._loadHash(i)},e.Loader.prototype.loadMap=function(t){return this._loadHash({data:this.loadData("maps/"+t),colormap:this.loadImage("pics/colormap.png"),texture:this.loadImage("maps/"+t+".png"),normals:this.loadData("normals")}).then(function(t){const e=t.data.entities;return this._loadEntityModels(e).then(function(e){return t.models=e,t})}.bind(this))},e.Physics={},e.Physics.clip=function(t,i,n,s,o,r){const a=r-(t.x+i.x)*n-(t.y+i.y)*s-(t.z+i.z)*o+e.Physics.EPSILON;i.x+=n*a,i.y+=s*a,i.z+=o*a},e.Physics.GRAVITY=800,e.Physics.STEP_SIZE=18,e.Physics.EPSILON=.125,e.Entities={dictionary:Object.create(null)},e.Cluster=function(t,e,i){this._gl=t;var n=[],s=[],o=[],r=[],a=[];const m=function(t,i,m){n.push(e.vertices[3*t],e.vertices[3*t+1],e.vertices[3*t+2]),i<0?s.push(-e.planes.data[4*-i],-e.planes.data[4*-i+1],-e.planes.data[4*-i+2]):s.push(e.planes.data[4*i],e.planes.data[4*i+1],e.planes.data[4*i+2]),o.push(e.vertices[3*t+0]*e.textureInformation.u[4*m+0]+e.vertices[3*t+1]*e.textureInformation.u[4*m+1]+e.vertices[3*t+2]*e.textureInformation.u[4*m+2]+e.textureInformation.u[4*m+3]),o.push(e.vertices[3*t+0]*e.textureInformation.v[4*m+0]+e.vertices[3*t+1]*e.textureInformation.v[4*m+1]+e.vertices[3*t+2]*e.textureInformation.v[4*m+2]+e.textureInformation.v[4*m+3]),r.push(e.textureInformation.x[m],e.textureInformation.y[m]),a.push(e.textureInformation.w[m],e.textureInformation.h[m])};for(var l=0;l<i.length;l++)!function(t){var i=e.faceEdges[e.faces.edges.offset[t]];i=i<0?e.edges[2*-i+1]:e.edges[2*i];for(var n=1;n<e.faces.edges.size[t]-1;n++){m(i,e.faces.planes[t],e.faces.textureInformation[t]);const s=e.faceEdges[e.faces.edges.offset[t]+n];s<0?(m(e.edges[2*-s+1],e.faces.planes[t],e.faces.textureInformation[t]),m(e.edges[2*-s],e.faces.planes[t],e.faces.textureInformation[t])):(m(e.edges[2*s],e.faces.planes[t],e.faces.textureInformation[t]),m(e.edges[2*s+1],e.faces.planes[t],e.faces.textureInformation[t]))}}(i[l]);this._size=n.length/3,this._vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),delete n,this._normalBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._normalBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),delete s,this._textureCoordinateBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._textureCoordinateBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW),delete o,this._textureOriginBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._textureOriginBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW),delete r,this._textureSizeBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._textureSizeBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(a),t.STATIC_DRAW),delete a},e.Cluster.prototype.render=function(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.vertexAttribPointer(0,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._normalBuffer),t.vertexAttribPointer(1,3,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._textureCoordinateBuffer),t.vertexAttribPointer(2,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._textureOriginBuffer),t.vertexAttribPointer(3,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this._textureSizeBuffer),t.vertexAttribPointer(4,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,this._size)},e.PVS={},e.PVS.parse=function(t){const e=t.visibility.map(function(t){const e=window.atob(t),i=new Uint8Array(e.length);for(var n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}),i=Object.create(null);for(var n=0;n<e.length;n++){i[n]=[];for(var s=0,o=0;s<e[n].length;s++)if(e[n][s])for(var r=1;r<256;r*=2,o++)e[n][s]&r&&i[n].push(o);else o+=8*e[n][++s]}return i},e.BSP=function(t,i){return this._clusters=Object.create(null),this._mapFaces(i,0),this._createClusters(t,i,0),this._pvs=e.PVS.parse(i),this._parse(i,0)},e.BSP.prototype._mapFaces=function(t,e){if(e<0){const i=-(e+1),n=t.leaves.faces.first[i],s=t.leaves.faces.count[i];if(s>0){const e=t.leaves.faces.table.slice(n,n+s),o=t.leaves.cluster[i];o>=0&&(o in this._clusters||(this._clusters[o]=[]),this._clusters[o]=this._clusters[o].concat(e))}}else this._mapFaces(t,t.nodes.front[e]),this._mapFaces(t,t.nodes.back[e])},e.BSP.prototype._createClusters=function(t,i){for(var n in this._clusters)this._clusters[n]=new e.Cluster(t,i,this._clusters[n])},e.BSP.prototype._getLeafClusters=function(t,e){const i=Object.create(null),n=t.leaves.cluster[e];return n>=0&&this._pvs[n].forEach(function(t){this._clusters[t]&&(i[t]=this._clusters[t])},this),i},e.BSP.prototype._parse=function(t,i){if(i<0){const n=-(i+1),s=this._getLeafClusters(t,n);return new e.BSP.Leaf(t,n,s)}return new e.BSP.Node(this,t,i)},e.BSP.Node=function(t,e,i){const n=e.nodes.plane[i];this.plane=e.planes.data.slice(4*n,4*(n+1)),this.front=t._parse(e,e.nodes.front[i]),this.back=t._parse(e,e.nodes.back[i])},e.BSP.Node._temp={x:0,y:0,z:0},e.BSP.Node.prototype.locate=function(t){return t.x*this.plane[0]+t.y*this.plane[1]+t.z*this.plane[2]-this.plane[3]<0?this.back.locate(t):this.front.locate(t)},e.BSP.Node.prototype._isEmpty=function(){const t=e.BSP.Node._temp;return t.x*this.plane[0]+t.y*this.plane[1]+t.z*this.plane[2]-this.plane[3]<0?this.back._isEmpty():this.front._isEmpty()},e.BSP.Node.prototype._clip=function(t,i){const n=this.plane[0],s=this.plane[1],o=this.plane[2],r=this.plane[3],a=t.x,m=t.y,l=t.z,c=(t.x+i.x)*n+(t.y+i.y)*s+(t.z+i.z)*o-r;return a*n+m*s+l*o-r<0?c<0?this.back._clip(t,i):!!this._isEmpty()&&(e.Physics.clip(t,i,-n,-s,-o,-r),!0):c<0?!!this._isEmpty()&&(e.Physics.clip(t,i,n,s,o,r),!0):this.front._clip(t,i)},e.BSP.Node.prototype.clip=function(t,i){const n=e.BSP.Node._temp;n.x=t.x+i.x,n.y=t.y+i.y,n.z=t.z+i.z;for(var s=!1;this._clip(t,i);)s=!0,n.x=t.x+i.x,n.y=t.y+i.y,n.z=t.z+i.z;return s},e.BSP.Leaf=function(t,e,i){this._clusterIndex=t.leaves.cluster[e],this._clusters=i;for(var n in i)return void(this.empty=!1);this.empty=!0},e.BSP.Leaf.prototype.locate=function(){return this},e.BSP.Leaf.prototype._isEmpty=function(){return this.empty},e.BSP.Leaf.prototype._clip=function(){return!1},e.BSP.Leaf.prototype.views=function(t){return t._clusterIndex in this._clusters},e.BSP.Leaf.prototype.render=function(){for(var t in this._clusters)this._clusters[t].render()},e.Camera=function(t){this._bsp=t,this.origin={x:0,y:0,z:0},this.head={x:0,y:0,z:0},this.offset={x:0,y:0,z:0},this.velocity={x:0,y:0,z:0},this.angle={x:0,y:0},this.onGround=!1},e.Camera.HEIGHT=45,e.Camera.WALKING_SPEED=200,e.Camera.RUNNING_SPEED=320,e.Camera.prototype._move=function(t,i,n,s){this.velocity.y+=n;const o=i*Math.cos(this.angle.y)+s*-Math.sin(this.angle.y),r=(this.velocity.y-e.Physics.GRAVITY*t/2)*t,a=i*Math.sin(this.angle.y)+s*Math.cos(this.angle.y);this.offset.x=o,this.offset.y=e.Physics.STEP_SIZE,this.offset.z=a,this._bsp.clip(this.origin,this.offset),this.origin.x+=this.offset.x,this.origin.y+=this.offset.y,this.origin.z+=this.offset.z,this.offset.x=0,this.offset.y=r-e.Physics.STEP_SIZE,this.offset.z=0,this.onGround=this._bsp.clip(this.origin,this.offset),this.origin.x+=this.offset.x,this.origin.y+=this.offset.y,this.origin.z+=this.offset.z,this.head.x=this.origin.x,this.head.y=this.origin.y+e.Camera.HEIGHT,this.head.z=this.origin.z,this.onGround?this.velocity.y=0:this.velocity.y-=e.Physics.GRAVITY*t},e.Camera.prototype.setPosition=function(t,i,n){this.origin.x=t,this.origin.y=i,this.origin.z=n,this.head.x=t,this.head.y=i+e.Camera.HEIGHT,this.head.z=n},e.Camera.prototype.rotate=function(t,e){this.angle.x=Math.min(Math.PI/2,Math.max(-Math.PI/2,this.angle.x+t)),this.angle.y+=e},e.Camera.prototype._getSpeed=function(t){return t[16]?e.Camera.RUNNING_SPEED:e.Camera.WALKING_SPEED},e.Camera.prototype.tick=function(t,i,n){const s=(i-t)/1e3,o=this._getSpeed(n)*s;var r=0,a=0,m=0;n[65]&&(r-=o),n[68]&&(r+=o),n[83]&&(m-=o),n[87]&&(m+=o),n[32]&&this.onGround&&(a=10*e.Physics.GRAVITY*s),this._move(s,r,a,m)},e.WorldProgram=function(t,e,i){this._gl=t,this._camera=i,this._textures={palette:t.createTexture(),atlas:t.createTexture()},t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._textures.palette),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.colormap),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this._textures.atlas),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.texture);const n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,document.getElementById("world-vertex-shader").text),t.compileShader(n),console.log(t.getShaderInfoLog(n));const s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,document.getElementById("world-fragment-shader").text),t.compileShader(s),console.log(t.getShaderInfoLog(s)),this._program=t.createProgram(),t.attachShader(this._program,n),t.attachShader(this._program,s),t.bindAttribLocation(this._program,0,"in_Vertex"),t.bindAttribLocation(this._program,1,"in_Normal"),t.bindAttribLocation(this._program,2,"in_TextureCoordinates"),t.bindAttribLocation(this._program,3,"in_TextureOrigin"),t.bindAttribLocation(this._program,4,"in_TextureSize"),t.linkProgram(this._program),console.log(t.getProgramInfoLog(this._program)),this._locations={screenSize:t.getUniformLocation(this._program,"ScreenSize"),position:t.getUniformLocation(this._program,"Position"),angle:t.getUniformLocation(this._program,"Angle"),atlasSize:t.getUniformLocation(this._program,"AtlasSize"),palette:t.getUniformLocation(this._program,"Palette"),atlas:t.getUniformLocation(this._program,"Atlas")},t.useProgram(this._program),t.uniform2f(this._locations.atlasSize,e.texture.width,e.texture.height),t.uniform1i(this._locations.palette,0),t.uniform1i(this._locations.atlas,1)},e.WorldProgram.prototype.resizeScreen=function(t,e){const i=this._gl;i.useProgram(this._program),i.uniform3f(this._locations.screenSize,t,e,Math.max(t,e))},e.WorldProgram.prototype.prepare=function(){const t=this._gl;t.useProgram(this._program),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._textures.palette),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this._textures.atlas),t.uniform3f(this._locations.position,this._camera.head.x,this._camera.head.y,this._camera.head.z),t.uniform2f(this._locations.angle,this._camera.angle.x,this._camera.angle.y)},e.ModelProgram=function(t,e){this._gl=t,this._camera=e;const i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,document.getElementById("model-vertex-shader").text),t.compileShader(i),console.log(t.getShaderInfoLog(i));const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,document.getElementById("model-fragment-shader").text),t.compileShader(n),console.log(t.getShaderInfoLog(n)),this._program=t.createProgram(),t.attachShader(this._program,i),t.attachShader(this._program,n),t.bindAttribLocation(this._program,0,"in_PreviousVertex"),t.bindAttribLocation(this._program,1,"in_NextVertex"),t.bindAttribLocation(this._program,2,"in_PreviousNormal"),t.bindAttribLocation(this._program,3,"in_NextNormal"),t.bindAttribLocation(this._program,4,"in_TextureCoordinates"),t.linkProgram(this._program),console.log(t.getProgramInfoLog(this._program)),this.locations={camera:{position:t.getUniformLocation(this._program,"Camera.Position"),angle:t.getUniformLocation(this._program,"Camera.Angle")},position:t.getUniformLocation(this._program,"Position"),angle:t.getUniformLocation(this._program,"Angle"),texture:t.getUniformLocation(this._program,"Texture"),step:t.getUniformLocation(this._program,"Step"),screenSize:t.getUniformLocation(this._program,"ScreenSize")},t.useProgram(this._program),t.uniform1i(this.locations.texture,2)},e.ModelProgram.prototype.resizeScreen=function(t,e){const i=this._gl;i.useProgram(this._program),i.uniform3f(this.locations.screenSize,t,e,Math.max(t,e))},e.ModelProgram.prototype.prepareForEntities=function(){const t=this._gl;t.useProgram(this._program),t.uniform3f(this.locations.camera.position,this._camera.head.x,this._camera.head.y,this._camera.head.z),t.uniform2f(this.locations.camera.angle,this._camera.angle.x,this._camera.angle.y),t.activeTexture(t.TEXTURE2)},e.ModelProgram.prototype.prepareForWeapon=function(){const t=this._gl;t.uniform3f(this.locations.camera.position,0,0,0),t.uniform2f(this.locations.camera.angle,0,0)},e.BaseModel=function(t,i,n,s,o,r){this._gl=t,this._program=i,this.name=n,this.animations=e.BaseModel._loadAnimations(s),this._vertexBuffer=t.createBuffer(),this._normalBuffer=t.createBuffer(),this._textureCoordinateBuffer=t.createBuffer(),this._size=s.triangles.vertices.length;const a=new Float32Array(s.frames.names.length*s.triangles.vertices.length*3);for(h=0;h<s.frames.names.length;h++)for(l=0;l<s.triangles.vertices.length;l++)a[3*(h*s.triangles.vertices.length+l)+0]=s.frames.vertices[3*(h*s.frames.vertexCount+s.triangles.vertices[l])+0]*s.frames.scale[3*h+0]+s.frames.translate[3*h+0],a[3*(h*s.triangles.vertices.length+l)+2]=s.frames.vertices[3*(h*s.frames.vertexCount+s.triangles.vertices[l])+1]*s.frames.scale[3*h+1]+s.frames.translate[3*h+1],a[3*(h*s.triangles.vertices.length+l)+1]=s.frames.vertices[3*(h*s.frames.vertexCount+s.triangles.vertices[l])+2]*s.frames.scale[3*h+2]+s.frames.translate[3*h+2];t.bindBuffer(t.ARRAY_BUFFER,this._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),delete a;const m=new Float32Array(s.frames.names.length*s.triangles.vertices.length*3);for(h=0;h<s.frames.names.length;h++)for(var l=0;l<s.triangles.vertices.length;l++){const t=r[s.frames.normals[h*s.frames.vertexCount+s.triangles.vertices[l]]];m[3*(h*s.triangles.vertices.length+l)+0]=t[0],m[3*(h*s.triangles.vertices.length+l)+2]=t[1],m[3*(h*s.triangles.vertices.length+l)+1]=t[2]}t.bindBuffer(t.ARRAY_BUFFER,this._normalBuffer),t.bufferData(t.ARRAY_BUFFER,m,t.STATIC_DRAW),delete m;const c=new Float32Array(2*s.triangles.textureCoordinates.length);for(var h=0;h<s.triangles.textureCoordinates.length;h++){const t=2*s.triangles.textureCoordinates[h];c[2*h+0]=s.textureCoordinates[t+0]/s.skin.width,c[2*h+1]=s.textureCoordinates[t+1]/s.skin.height}t.bindBuffer(t.ARRAY_BUFFER,this._textureCoordinateBuffer),t.bufferData(t.ARRAY_BUFFER,c,t.STATIC_DRAW),delete c,this._textures={},t.activeTexture(t.TEXTURE2);for(var n in o)this._textures[n]=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._textures[n]),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,o[n])},e.BaseModel._loadAnimations=function(t){const e=Object.create(null);t.frames.names.forEach(function(t,i){const n=/^([a-z_]+)(\d*)$/.exec(t);n&&(n[1]in e||(e[n[1]]=Object.create(null)),e[n[1]][n[2]]=i)});for(var i in e)e[i]=Object.keys(e[i]).sort().map(function(t){return e[i][t]});return e},e.BaseModel.prototype.render=function(t,e,i,n,s,o,r,a){const m=this._gl,l=this._program;m.uniform3f(l.locations.position,t,e,i),m.uniform1f(l.locations.angle,n),m.uniform1f(l.locations.step,r),m.bindBuffer(m.ARRAY_BUFFER,this._vertexBuffer),m.vertexAttribPointer(0,3,m.FLOAT,!1,0,12*this._size*s),m.vertexAttribPointer(1,3,m.FLOAT,!1,0,12*this._size*o),m.bindBuffer(m.ARRAY_BUFFER,this._normalBuffer),m.vertexAttribPointer(2,3,m.FLOAT,!1,0,12*this._size*s),m.vertexAttribPointer(3,3,m.FLOAT,!1,0,12*this._size*o),m.bindBuffer(m.ARRAY_BUFFER,this._textureCoordinateBuffer),m.vertexAttribPointer(4,2,m.FLOAT,!1,0,0),m.bindTexture(m.TEXTURE_2D,this._textures[a]),m.drawArrays(m.TRIANGLES,0,this._size)},e.AnimatedModel=function(t){this._model=t,this._animation=null},e.AnimatedModel.FRAME_DURATION=100,e.AnimatedModel.prototype.setSkin=function(t){this._skin=t},e.AnimatedModel.prototype.play=function(t){this._animation={name:t,firstFrame:0,lastFrame:this._model.animations[t].length-1,startTime:Date.now()}},e.AnimatedModel.prototype.playFrames=function(t,e,i){this._animation={name:t,firstFrame:e,lastFrame:i,startTime:Date.now()}},e.AnimatedModel.prototype.stop=function(){this._animation=null},e.AnimatedModel.prototype.render=function(t,i,n,s,o){if(this._animation){const r=this._model.animations[this._animation.name],a=o-this._animation.startTime,m=Math.floor(a/e.AnimatedModel.FRAME_DURATION),l=this._animation.lastFrame-this._animation.firstFrame+1,c=r[this._animation.firstFrame+m%l],h=r[this._animation.firstFrame+(m+1)%l],d=a/e.AnimatedModel.FRAME_DURATION%m;this._model.render(t,i,n,s,c,h,d,this._skin)}},e.PositionedModel=function(t,i,n){e.AnimatedModel.call(this,t),this.position=i,this.angle=n},e.inherit(e.AnimatedModel,e.PositionedModel),e.PositionedModel.prototype.render=function(t){e.AnimatedModel.prototype.render.call(this,this.position.x,this.position.y,this.position.z,this.angle,t)},e.ModelFactory=function(t,i,n,s){this._baseModels=Object.create(null);for(var o in n)this._baseModels[o]=new e.BaseModel(t,i,o,n[o].data,n[o].skins,s);this.models=[]},e.ModelFactory.prototype.create=function(t){if(t in this._baseModels){const i=this._baseModels[t];return new e.AnimatedModel(i)}throw new Error('unknown model "'+t+'"')},e.ModelFactory.prototype.spawn=function(t,i,n){if(t in this._baseModels){const s=this._baseModels[t],o=new e.PositionedModel(s,i,n);return this.models.push(o),o}throw new Error('unknown model "'+t+'"')},e.Weapons={},e.Weapons.Blaster=function(t){this._model=t.create("weapons/v_blast"),this._model.setSkin("models/weapons/v_blast/skin"),this._model.play("idle")},e.Weapons.Blaster.prototype.render=function(t){this._model.render(0,0,0,Math.PI/2,t)},e.Entities.Barrel=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("objects/barrels",i,n),this._model.setSkin("models/objects/barrels/skin"),this._model.playFrames("barrel",0,0)},e.Entities.Barrel.MODELS=["objects/barrels"],e.Entities.Barrel.prototype.tick=function(){},e.Entities.dictionary.misc_explobox=e.Entities.Barrel,e.Entities.Berserk=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/berserk",i,n),this._model.setSkin("models/monsters/berserk/skin"),this._model.play("stand")},e.Entities.Berserk.MODELS=["monsters/berserk"],e.Entities.Berserk.prototype.tick=function(){},e.Entities.dictionary.monster_berserk=e.Entities.Berserk,e.Entities.Boss2=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/boss2",i,n),this._model.setSkin("models/monsters/boss2/skin"),this._model.play("stand")},e.Entities.Boss2.MODELS=["monsters/boss2"],e.Entities.Boss2.prototype.tick=function(){},e.Entities.dictionary.monster_boss2=e.Entities.Boss2,e.Entities.Jorg=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/boss3/jorg",i,n),this._model.setSkin("models/monsters/boss3/jorg/skin"),this._model.play("stand")},e.Entities.Jorg.MODELS=["monsters/boss3/jorg","monsters/boss3/rider"],e.Entities.Jorg.prototype.tick=function(){},e.Entities.dictionary.monster_jorg=e.Entities.Jorg,e.Entities.Rider=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/boss3/rider",i,n),this._model.setSkin("models/monsters/boss3/rider/skin"),this._model.play("stand")},e.Entities.Rider.MODELS=["monsters/boss3/rider"],e.Entities.Rider.prototype.tick=function(){},e.Entities.dictionary.monster_boss3_stand=e.Entities.Rider,e.Entities.Brain=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/brain",i,n),this._model.setSkin("models/monsters/brain/skin"),this._model.play("stand")},e.Entities.Brain.MODELS=["monsters/brain"],e.Entities.Brain.prototype.tick=function(){},e.Entities.dictionary.monster_brain=e.Entities.Brain,e.Entities.Chick=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/bitch",i,n),this._model.setSkin("models/monsters/bitch/skin"),this._model.play("stand")},e.Entities.Chick.MODELS=["monsters/bitch"],e.Entities.Chick.prototype.tick=function(){},e.Entities.dictionary.monster_chick=e.Entities.Chick,e.Entities.DeadBody=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("deadbods/dude",i,n),this._model.setSkin("models/deadbods/dude/dead1");var s;s=2&e.spawnflags?1:4&e.spawnflags?2:8&e.spawnflags?3:16&e.spawnflags?4:32&e.spawnflags?5:0,this._model.playFrames("body",s,s)},e.Entities.DeadBody.MODELS=["deadbods/dude"],e.Entities.DeadBody.prototype.tick=function(){},e.Entities.dictionary.misc_deadsoldier=e.Entities.DeadBody,e.Entities.Floater=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/float",i,n),this._model.setSkin("models/monsters/float/skin"),this._model.play("stand")},e.Entities.Floater.MODELS=["monsters/float"],e.Entities.Floater.prototype.tick=function(){},e.Entities.dictionary.monster_floater=e.Entities.Floater,e.Entities.Flyer=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/flyer",i,n),this._model.setSkin("models/monsters/flyer/skin"),this._model.play("stand")},e.Entities.Flyer.MODELS=["monsters/flyer"],e.Entities.Flyer.prototype.tick=function(){},e.Entities.dictionary.monster_flyer=e.Entities.Flyer,e.Entities.Gladiator=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/gladiatr",i,n),this._model.setSkin("models/monsters/gladiatr/skin"),this._model.play("stand")},e.Entities.Gladiator.MODELS=["monsters/gladiatr"],e.Entities.Gladiator.prototype.tick=function(){},e.Entities.dictionary.monster_gladiator=e.Entities.Gladiator,e.Entities.Gunner=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/gunner",i,n),this._model.setSkin("models/monsters/gunner/skin"),this._model.play("stand")},e.Entities.Gunner.MODELS=["monsters/gunner"],e.Entities.Gunner.prototype.tick=function(){},e.Entities.dictionary.monster_gunner=e.Entities.Gunner,e.Entities.Hover=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/hover",i,n),this._model.setSkin("models/monsters/hover/skin"),this._model.play("stand")},e.Entities.Hover.MODELS=["monsters/hover"],e.Entities.Hover.prototype.tick=function(){},e.Entities.dictionary.monster_hover=e.Entities.Hover,e.Entities.Infantry=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/infantry",i,n),this._model.setSkin("models/monsters/infantry/skin"),this._model.playFrames("stand",48,70)},e.Entities.Infantry.MODELS=["monsters/infantry"],e.Entities.Infantry.prototype.tick=function(){},e.Entities.dictionary.monster_infantry=e.Entities.Infantry,e.Entities.Medic=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/medic",i,n),this._model.setSkin("models/monsters/medic/skin"),this._model.play("wait")},e.Entities.Medic.MODELS=["monsters/medic"],e.Entities.Medic.prototype.tick=function(){},e.Entities.dictionary.monster_medic=e.Entities.Medic,e.Entities.Mutant=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/mutant",i,n),this._model.setSkin("models/monsters/mutant/skin"),this._model.play("stand")},e.Entities.Mutant.MODELS=["monsters/mutant"],e.Entities.Mutant.prototype.tick=function(){},e.Entities.dictionary.monster_mutant=e.Entities.Mutant,e.Entities.Parasite=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/parasite",i,n),this._model.setSkin("models/monsters/parasite/skin"),this._model.play("stand")},e.Entities.Parasite.MODELS=["monsters/parasite","monsters/parasite/segment","monsters/parasite/tip"],e.Entities.Parasite.prototype.tick=function(){},e.Entities.dictionary.monster_parasite=e.Entities.Parasite,e.Entities.Soldier=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;switch(this._model=t.spawn("monsters/soldier",i,n),e.classname){case"monster_soldier_light":this._model.setSkin("models/monsters/soldier/skin_lt"),this._model.playFrames("stand",0,29);break;case"monster_soldier_ss":this._model.setSkin("models/monsters/soldier/skin_ss"),this._model.playFrames("stand",30,68);break;default:this._model.setSkin("models/monsters/soldier/skin"),this._model.playFrames("stand",30,68)}},e.Entities.Soldier.MODELS=["monsters/soldier"],e.Entities.Soldier.prototype.tick=function(){},e.Entities.dictionary.monster_soldier=e.Entities.Soldier,e.Entities.dictionary.monster_soldier_light=e.Entities.Soldier,e.Entities.dictionary.monster_soldier_ss=e.Entities.Soldier,e.Entities.Static=function(t,i){const n={x:i.origin[0],y:i.origin[1],z:i.origin[2]},s=i.angle||0;this._model=t.spawn(e.Entities.Static._MODEL_MAP[i.classname],n,s),this._model.setSkin(e.Entities.Static._SKIN_MAP[i.classname]),this._model.play(e.Entities.Static._ANIMATION_MAP[i.classname])},e.Entities.Static._MODEL_MAP={ammo_bullets:"items/ammo/bullets/medium",ammo_cells:"items/ammo/cells/medium",ammo_grenades:"items/ammo/grenades/medium",ammo_rockets:"items/ammo/rockets/medium",ammo_shells:"items/ammo/shells/medium",ammo_slugs:"items/ammo/slugs/medium",item_adrenaline:"items/adrenal",item_armor_combat:"items/armor/combat",item_armor_jacket:"items/armor/jacket",item_armor_shard:"items/armor/shard",item_breather:"items/breather",item_enviro:"items/enviro",item_health:"items/healing/stimpack",item_health_large:"items/healing/large",item_health_mega:"items/mega_h",item_health_small:"items/healing/medium",item_invulnerability:"items/invulner",item_pack:"items/pack",item_quad:"items/quaddama",item_silencer:"items/silencer",misc_banner:"objects/banner",misc_gib_head:"objects/gibs/head",weapon_bfg:"weapons/g_bfg",weapon_chaingun:"weapons/g_chain",weapon_grenadelauncher:"weapons/g_launch",weapon_hyperblaster:"weapons/g_hyperb",weapon_machinegun:"weapons/g_machn",weapon_railgun:"weapons/g_rail",weapon_rocketlauncher:"weapons/g_rocket",weapon_shotgun:"weapons/g_shotg",weapon_supershotgun:"weapons/g_shotg2"},e.Entities.Static._SKIN_MAP={ammo_bullets:"models/items/ammo/bullets/medium/skin",ammo_cells:"models/items/ammo/cells/medium/skin",ammo_grenades:"models/items/ammo/grenades/medium/skin",ammo_rockets:"models/items/ammo/rockets/medium/skin",ammo_shells:"models/items/ammo/shells/medium/skin",ammo_slugs:"models/items/ammo/slugs/medium/skin",item_adrenaline:"models/items/adrenal/skin",item_armor_combat:"models/items/armor/combat/skin",item_armor_jacket:"models/items/armor/jacket/skin",item_armor_shard:"models/items/armor/shard/skin",item_breather:"models/items/breather/skin",item_enviro:"models/items/enviro/skin",item_health:"models/items/healing/stimpack/skin",item_health_large:"models/items/healing/large/skin",item_health_mega:"models/items/mega_h/skin",item_health_small:"models/items/healing/medium/skin",item_invulnerability:"models/items/invulner/skin",item_pack:"models/items/pack/skin",item_quad:"models/items/quaddama/skin",item_silencer:"models/items/silencer/skin",misc_banner:"models/objects/banner/skin",misc_gib_head:"models/objects/gibs/head/skin",weapon_bfg:"models/weapons/g_bfg/skin",weapon_chaingun:"models/weapons/g_chain/skin",weapon_grenadelauncher:"models/weapons/g_launch/skin",weapon_hyperblaster:"models/weapons/g_hyperb/skin",weapon_machinegun:"models/weapons/g_machn/skin",weapon_railgun:"models/weapons/g_rail/skin",weapon_rocketlauncher:"models/weapons/g_rocket/skin",weapon_shotgun:"models/weapons/g_shotg/skin",weapon_supershotgun:"models/weapons/g_shotg2/skin"},e.Entities.Static._ANIMATION_MAP={ammo_bullets:"bullets",ammo_cells:"cells",ammo_grenades:"grenade",ammo_rockets:"rockets",ammo_shells:"shells",ammo_slugs:"slugs",item_adrenaline:"adrenal",item_armor_combat:"combat",item_armor_jacket:"armor",item_armor_shard:"shard",item_breather:"breather",item_enviro:"enviro",item_health:"stimpack",item_health_large:"large",item_health_mega:"mega",item_health_small:"medium",item_invulnerability:"invulner",item_pack:"pack",item_quad:"quaddama",item_silencer:"silencer",misc_banner:"frame",misc_gib_head:"head",weapon_bfg:"g_bfg",weapon_chaingun:"g_chain",weapon_grenadelauncher:"g_launch",weapon_hyperblaster:"g_hyperb",weapon_machinegun:"g_machn",weapon_railgun:"g_rail",weapon_rocketlauncher:"g_rocket",weapon_shotgun:"g_shotd",weapon_supershotgun:"g_shotg"},e.Entities.Static.MODELS=["items/ammo/bullets/medium","items/ammo/cells/medium","items/ammo/grenades/medium","items/ammo/rockets/medium","items/ammo/shells/medium","items/ammo/slugs/medium","items/adrenal","items/armor/combat","items/armor/jacket","items/armor/shard","items/breather","items/enviro","items/healing/stimpack","items/healing/large","items/mega_h","items/healing/medium","items/invulner","items/pack","items/quaddama","items/silencer","objects/banner","objects/gibs/head","weapons/g_bfg","weapons/g_chain","weapons/g_launch","weapons/g_hyperb","weapons/g_machn","weapons/g_rail","weapons/g_rocket","weapons/g_shotg","weapons/g_shotg2"],e.Entities.Static.prototype.tick=function(){},e.Entities.dictionary.ammo_bullets=e.Entities.Static,e.Entities.dictionary.ammo_cells=e.Entities.Static,e.Entities.dictionary.ammo_grenades=e.Entities.Static,e.Entities.dictionary.ammo_rockets=e.Entities.Static,e.Entities.dictionary.ammo_shells=e.Entities.Static,e.Entities.dictionary.ammo_slugs=e.Entities.Static,e.Entities.dictionary.item_adrenaline=e.Entities.Static,e.Entities.dictionary.item_armor_combat=e.Entities.Static,e.Entities.dictionary.item_armor_jacket=e.Entities.Static,e.Entities.dictionary.item_armor_shard=e.Entities.Static,e.Entities.dictionary.item_breather=e.Entities.Static,e.Entities.dictionary.item_enviro=e.Entities.Static,e.Entities.dictionary.item_health=e.Entities.Static,e.Entities.dictionary.item_health_large=e.Entities.Static,e.Entities.dictionary.item_health_mega=e.Entities.Static,e.Entities.dictionary.item_health_small=e.Entities.Static,e.Entities.dictionary.item_invulnerability=e.Entities.Static,e.Entities.dictionary.item_pack=e.Entities.Static,e.Entities.dictionary.item_quad=e.Entities.Static,e.Entities.dictionary.item_silencer=e.Entities.Static,e.Entities.dictionary.misc_banner=e.Entities.Static,e.Entities.dictionary.misc_gib_head=e.Entities.Static,e.Entities.dictionary.weapon_bfg=e.Entities.Static,e.Entities.dictionary.weapon_chaingun=e.Entities.Static,e.Entities.dictionary.weapon_grenadelauncher=e.Entities.Static,e.Entities.dictionary.weapon_hyperblaster=e.Entities.Static,e.Entities.dictionary.weapon_machinegun=e.Entities.Static,e.Entities.dictionary.weapon_railgun=e.Entities.Static,e.Entities.dictionary.weapon_rocketlauncher=e.Entities.Static,e.Entities.dictionary.weapon_shotgun=e.Entities.Static,e.Entities.dictionary.weapon_supershotgun=e.Entities.Static,e.Entities.SuperTank=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;this._model=t.spawn("monsters/boss1",i,n),this._model.setSkin("models/monsters/boss1/skin"),this._model.play("stand")},e.Entities.SuperTank.MODELS=["monsters/boss1"],e.Entities.SuperTank.prototype.tick=function(){},e.Entities.dictionary.monster_supertank=e.Entities.SuperTank,e.Entities.Tank=function(t,e){const i={x:e.origin[0],y:e.origin[1],z:e.origin[2]},n=e.angle||0;switch(this._model=t.spawn("monsters/tank",i,n),e.classname){case"monster_tank_commander":this._model.setSkin("models/monsters/tank/../ctank/skin");break;default:this._model.setSkin("models/monsters/tank/skin")}this._model.play("stand")},e.Entities.Tank.MODELS=["monsters/tank"],e.Entities.Tank.prototype.tick=function(){},e.Entities.dictionary.monster_tank=e.Entities.Tank,e.Entities.dictionary.monster_tank_commander=e.Entities.Tank,e.Game=function(t,i){this._gl=t,t.clearColor(0,0,0,1),t.enable(t.DEPTH_TEST),t.clearDepth(0),t.depthFunc(t.GREATER),t.enable(t.CULL_FACE),t.frontFace(t.CW),t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._bsp=new e.BSP(t,i.data),this.camera=new e.Camera(this._bsp),this._worldProgram=new e.WorldProgram(t,i,this.camera),this._modelProgram=new e.ModelProgram(t,this.camera),this._modelFactory=new e.ModelFactory(t,this._modelProgram,i.models,i.normals),this.weapon=new e.Weapons.Blaster(this._modelFactory),this.entities=i.data.entities.filter(function(t){return t.classname in e.Entities.dictionary}).map(function(t){return new(0,e.Entities.dictionary[t.classname])(this._modelFactory,t)},this),i.data.entities.filter(function(t){return"info_player_start"===t.classname}).forEach(function(t){this.camera.setPosition(t.origin[0],t.origin[1],t.origin[2]),this.camera.angle.y=t.angle-Math.PI/2},this)},e.Game.prototype.resize=function(t,e){this._gl.viewport(0,0,t,e),this._worldProgram.resizeScreen(t,e),this._modelProgram.resizeScreen(t,e)},e.Game.prototype.tick=function(t,e,i){this.camera.tick(t,e,i)},e.Game.prototype.render=function(){const t=this._gl;t.clear(t.DEPTH_BUFFER_BIT);const e=Date.now();this._worldProgram.prepare();const i=this._bsp.locate(this.camera.head);i.render(),this._modelProgram.prepareForEntities();for(var n=0;n<this._modelFactory.models.length;n++){const t=this._modelFactory.models[n],s=this._bsp.locate(t.position);i.views(s)&&t.render(e)}this._modelProgram.prepareForWeapon(),this.weapon.render(e),t.flush()},$(function(){const t=document.getElementById("canvas"),i=t.getContext("webgl");(new e.Loader).loadMap("base1").then(function(n){const s=new e.Game(i,n),o=Object.create(null);var r;const a=function(){r=Math.max(window.innerWidth,window.innerHeight);const e=.75*window.innerWidth,i=.75*window.innerHeight;t.width=e,t.height=i,s.resize(e,i)};a();var m=Date.now();window.setInterval(function(){const t=Date.now();s.tick(m,t,o),m=t},33),$(t).on("click",function(){t.requestPointerLock()}),t.addEventListener("mousemove",function(t){s.camera.rotate(2*-(t.movementY||0)/r,2*-(t.movementX||0)/r)},!0),$(window).on("resize",function(){a()}).on("keydown",function(t){t.preventDefault(),o[t.which]=!0}).on("keyup",function(t){t.preventDefault(),o[t.which]=!1}),function t(){s.render(),window.requestAnimationFrame(t)}()})})}("undefined"==typeof quake2?quake2={}:quake2);</script></head><body><canvas id=canvas></canvas><script id=world-vertex-shader type=application/glsl>uniform vec3 Position; uniform vec2 Angle; uniform vec3 ScreenSize; attribute vec3 in_Vertex; attribute vec3 in_Normal; attribute vec2 in_TextureCoordinates; attribute vec2 in_TextureOrigin; attribute vec2 in_TextureSize; const float PI = acos(-1.0); const vec3 Light = normalize(vec3(1, 2, 3)); varying float ex_Brightness; varying vec2 ex_TextureCoordinates; varying vec2 ex_TextureOrigin; varying vec2 ex_TextureSize; void main() { ex_Brightness = 1.0 - abs(acos(dot(Light, in_Normal))) / PI; ex_TextureCoordinates = in_TextureCoordinates; ex_TextureOrigin = in_TextureOrigin; ex_TextureSize = in_TextureSize; vec4 Vertex = vec4(in_Vertex, 1); gl_Position = mat4( ScreenSize.z / ScreenSize.x, 0, 0, 0, 0, ScreenSize.z / ScreenSize.y, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1 ) * mat4( 1, 0, 0, 0, 0, cos(Angle.x), sin(Angle.x), 0, 0, -sin(Angle.x), cos(Angle.x), 0, 0, 0, 0, 1 ) * mat4( cos(Angle.y), 0, -sin(Angle.y), 0, 0, 1, 0, 0, sin(Angle.y), 0, cos(Angle.y), 0, 0, 0, 0, 1 ) * mat4( 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, -Position, 1 ) * vec4(in_Vertex, 1); }</script><script id=world-fragment-shader type=application/glsl>precision mediump float; uniform sampler2D Palette; uniform sampler2D Atlas; uniform vec2 AtlasSize; varying float ex_Brightness; varying vec2 ex_TextureCoordinates; varying vec2 ex_TextureOrigin; varying vec2 ex_TextureSize; vec2 mod2(vec2 a, vec2 b) { return mod(mod(a, b) + b, b); } void main() { vec2 TextureCoordinates = ex_TextureOrigin + mod2( ex_TextureCoordinates, ex_TextureSize ); float Index = texture2D(Atlas, TextureCoordinates / AtlasSize).r; vec4 Color = texture2D(Palette, vec2(Index, 0.002)); gl_FragColor = vec4(vec3(Color) * ex_Brightness, Color.a); }</script><script id=model-vertex-shader type=application/glsl>uniform struct { vec3 Position; vec2 Angle; } Camera; uniform vec3 Position; uniform float Angle; uniform float Step; uniform vec3 ScreenSize; attribute vec3 in_PreviousVertex; attribute vec3 in_NextVertex; attribute vec3 in_PreviousNormal; attribute vec3 in_NextNormal; attribute vec2 in_TextureCoordinates; const float PI = acos(-1.0); const vec3 Light = normalize(vec3(1, 2, 3)); varying float ex_Brightness; varying vec2 ex_TextureCoordinates; void main() { vec3 Normal = mat3( cos(Angle), 0, sin(Angle), 0, 1, 0, -sin(Angle), 0, cos(Angle) ) * mix(in_PreviousNormal, in_NextNormal, Step); ex_Brightness = 1.0 - abs(acos(dot(Light, Normal))) / PI; ex_TextureCoordinates = in_TextureCoordinates; gl_Position = mat4( ScreenSize.z / ScreenSize.x, 0, 0, 0, 0, ScreenSize.z / ScreenSize.y, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1 ) * mat4( 1, 0, 0, 0, 0, cos(Camera.Angle.x), sin(Camera.Angle.x), 0, 0, -sin(Camera.Angle.x), cos(Camera.Angle.x), 0, 0, 0, 0, 1 ) * mat4( cos(Camera.Angle.y), 0, -sin(Camera.Angle.y), 0, 0, 1, 0, 0, sin(Camera.Angle.y), 0, cos(Camera.Angle.y), 0, 0, 0, 0, 1 ) * mat4( 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, Position - Camera.Position, 1 ) * mat4( cos(Angle), 0, sin(Angle), 0, 0, 1, 0, 0, -sin(Angle), 0, cos(Angle), 0, 0, 0, 0, 1 ) * vec4(mix(in_PreviousVertex, in_NextVertex, Step), 1); }</script><script id=model-fragment-shader type=application/glsl>precision mediump float; uniform sampler2D Texture; varying float ex_Brightness; varying vec2 ex_TextureCoordinates; void main() { vec4 Color = texture2D(Texture, ex_TextureCoordinates); gl_FragColor = vec4(vec3(Color) * ex_Brightness, Color.a); }</script></body></html>